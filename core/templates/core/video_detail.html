{% extends 'core/base.html' %}

{% block title %}{{ video.title }} - Immerse{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <p class="mb-3"><a href="{% url 'video_list' %}">&larr; Voltar para a lista de vídeos</a></p>
                <h1 class="card-title mb-3">{{ video.title }}</h1>
                {% if video.category %}
                    <p>
                        <a href="{% url 'category_view' video.category.name %}" class="badge text-decoration-none bg-primary fs-6">{{ video.category.name }}</a>
                    </p>
                {% endif %}
                <p class="lead text-muted">{{ video.description }}</p>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="ratio ratio-16x9">
                <iframe src="{{ video.embed_url }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Questionário</h2>
            </div>
            <div class="card-body">
                
                {% if user.is_authenticated %}
                    
                    {% if user_progress %}
                        <div class="alert alert-success" role="alert">
                            <h4 class="alert-heading">Parabéns!</h4>
                            <p>Você já completou este quiz e sua pontuação foi <strong>{{ user_progress.score }}</strong>.</p>
                        </div>
                    {% else %}
                        <div class="quiz-form">
                            {% csrf_token %}
                            {% for question in video.questions.all %}
                                <div class="question mb-4" id="question-{{ question.pk }}">
                                    <p><strong>{{ question.question_text }}</strong></p>
                                    <div class="list-group">
                                    {% for choice in question.choices.all %}
                                        <div class="list-group-item">
                                            <input type="radio" class="form-check-input me-2" name="question_{{ question.pk }}" id="choice_{{ choice.pk }}" value="{{ choice.pk }}">
                                            <label class="form-check-label" for="choice_{{ choice.pk }}">{{ choice.choice_text }}</label>
                                        </div>
                                    {% endfor %}
                                    </div>

                                    <div id="explanation-{{ question.pk }}" class="alert alert-info mt-3" style="display: none;"></div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                {% else %}
                    <div class="alert alert-info" role="alert">
                        <a href="{% url 'login' %}">Faça o login</a> ou <a href="{% url 'register' %}">crie uma conta</a> para responder ao quiz e salvar seu progresso!
                    </div>
                {% endif %}

            </div>
        </div>
        
    </div>
</div>

{% if user.is_authenticated and not user_progress %}
    {{ js_data|json_script:"js-data" }}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dataElement = document.getElementById('js-data');
            const jsData = JSON.parse(dataElement.textContent);
            const videoId = jsData.videoId;
            const totalQuestions = jsData.totalQuestions;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            let score = 0;
            let answeredQuestions = 0;

            radioButtons.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    const choiceId = this.value;
                    const questionElement = this.closest('.question');
                    const questionId = questionElement.id.replace('question-', '');

                    questionElement.querySelectorAll('input[type="radio"]').forEach(input => input.disabled = true);
                    
                    answeredQuestions++;

                    fetch(`/check-answer/?choice_id=${choiceId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error(data.error);
                                return;
                            }

                            const userLabel = this.parentElement.querySelector('label');
                            const icon = document.createElement('i');
                            icon.classList.add('bi', 'feedback-icon');

                            if (data.user_choice_is_correct) {
                                userLabel.classList.add('correct');
                                score++;
                                icon.classList.add('bi-check-circle-fill', 'icon-correct');
                                userLabel.insertAdjacentElement('afterend', icon);
                            } else {
                                userLabel.classList.add('incorrect');
                                icon.classList.add('bi-x-circle-fill', 'icon-incorrect');
                                userLabel.insertAdjacentElement('afterend', icon);

                                const correctLabel = questionElement.querySelector(`label[for="choice_${data.correct_choice_id}"]`);
                                if (correctLabel) {
                                    correctLabel.classList.add('correct');
                                    const correctIcon = document.createElement('i');
                                    correctIcon.classList.add('bi', 'feedback-icon', 'bi-check-circle-fill', 'icon-correct');
                                    correctLabel.insertAdjacentElement('afterend', correctIcon);
                                }
                            }

                            const explanationDiv = document.getElementById(`explanation-${questionId}`);
                            if (data.explanation && explanationDiv) {
                                explanationDiv.innerHTML = `<strong>Explicação:</strong> ${data.explanation}`;
                                explanationDiv.style.display = 'block';
                            }
                            
                            if (answeredQuestions === totalQuestions) {
                                alert(`Quiz finalizado! Sua pontuação: ${score} de ${totalQuestions}`);
                                fetch('/save-progress/', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                                    body: JSON.stringify({
                                        video_id: videoId,
                                        score: score,
                                        total_questions: totalQuestions
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data.message);
                                    window.location.reload();
                                });
                            }
                        });
                });
            });
        });
    </script>
{% endif %}
{% endblock %}