{% extends 'core/base.html' %}

{% block title %}{{ video.title }} - Immerse{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <p class="mb-3"><a href="{% url 'video_list' %}">&larr; Voltar para a lista de vídeos</a></p>
                <h1 class="card-title mb-3">{{ video.title }}</h1>
                <p class="lead text-muted">{{ video.description }}</p>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="ratio ratio-16x9">
                <iframe src="{{ video.video_url|slice:'0:24' }}embed/{{ video.video_url|slice:'32:' }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Questionário</h2>
            </div>
            <div class="card-body">
                
                {% if user.is_authenticated %}
                    
                    {% if user_progress %}
                        <div class="alert alert-success" role="alert">
                            <h4 class="alert-heading">Parabéns!</h4>
                            <p>Você já completou este quiz e sua pontuação foi <strong>{{ user_progress.score }}</strong>.</p>
                        </div>
                    {% else %}
                        <div class="quiz-form">
                            {% csrf_token %} {% for question in video.questions.all %}
                                <div class="question mb-4">
                                    <p><strong>{{ question.question_text }}</strong></p>
                                    <div class="list-group">
                                    {% for choice in question.choices.all %}
                                        <div class="list-group-item">
                                            <input type="radio" class="form-check-input me-2" name="question_{{ question.pk }}" id="choice_{{ choice.pk }}" value="{{ choice.pk }}">
                                            <label class="form-check-label" for="choice_{{ choice.pk }}">{{ choice.choice_text }}</label>
                                        </div>
                                    {% endfor %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted">Ainda não há perguntas para este vídeo.</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                {% else %}
                    <div class="alert alert-info" role="alert">
                        <a href="{% url 'login' %}">Faça o login</a> ou <a href="{% url 'register' %}">crie uma conta</a> para responder ao quiz e salvar seu progresso!
                    </div>
                {% endif %}

            </div>
        </div>
        
    </div>
</div>

{% if user.is_authenticated and not user_progress %}
    {{ js_data|json_script:"js-data" }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // ======================================================================
            // MUDANÇA IMPORTANTE 2: Lendo os dados do bloco JSON seguro
            // ======================================================================
            const dataElement = document.getElementById('js-data');
            const jsData = JSON.parse(dataElement.textContent);
            const videoId = jsData.videoId;
            const totalQuestions = jsData.totalQuestions;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // O resto do script permanece igual...
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            let score = 0;
            let answeredQuestions = 0;

            radioButtons.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    const choiceId = this.value;
                    const questionId = this.name;
                    const label = this.parentElement.querySelector('label');

                    document.querySelectorAll(`input[name="${questionId}"]`).forEach(input => input.disabled = true);
                    
                    answeredQuestions++;

                    fetch(`/check-answer/?choice_id=${choiceId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.is_correct) {
                                label.classList.add('correct');
                                score++;
                            } else {
                                label.classList.add('incorrect');
                            }

                            if (answeredQuestions === totalQuestions) {
                                alert(`Quiz finalizado! Sua pontuação: ${score} de ${totalQuestions}`);
                                
                                fetch('/save-progress/', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': csrfToken
                                    },
                                    body: JSON.stringify({
                                        video_id: videoId,
                                        score: score,
                                        total_questions: totalQuestions
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data.message);
                                    window.location.reload();
                                });
                            }
                        });
                });
            });
        });
    </script>
{% endif %}
{% endblock %}